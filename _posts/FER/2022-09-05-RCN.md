---
title:  "[Paper ReviewğŸ“ƒ] Convolutional relation network for facial expression recognition in the wild with few-shot learning"
excerpt: ""

categories:
  - FER
  - Attention
  - fsl
  - Relation Network
tags: [Deeplearning, FER]

last_modified_at: 2022-09-05T08:06:00-05:00
---

ì˜¤ëŠ˜ ë¦¬ë·°í•  ë…¼ë¬¸ì€ â¡ï¸ Zhu, Qing, et al. "Convolutional relation network for facial expression recognition in the wild with few-shot learning."Â Expert Systems with ApplicationsÂ 189 (2022): 116046.

FERì˜ ì„±ëŠ¥ì„ ëŒì–´ì˜¬ë¦´ ìˆ˜ ìˆëŠ” ìƒˆë¡œìš´ metric ë°©ì‹ì„ ì—°êµ¬í•˜ì—¬ few-shot learningì˜ ë‹¤ë¥¸ methodë“¤ê³¼ ë¹„êµí•œ ë…¼ë¬¸ì´ë‹¤. FERë¶„ì•¼ì— ë§ì¶¤í˜• metricì„ ì„ ë³´ì˜€ë‹¤ëŠ” ê²ƒì—ì„œ ì˜ì˜ê°€ ìˆëŠ”ë° ë‚´ìš©ì€ ì¡°ê¸ˆ ë¶€ì‹¤í•´ì„œ ì•„ì‰¬ì› ë˜ ë…¼ë¬¸ì´ë‹¤. 

í•˜ì§€ë§Œ FER ë¶„ì•¼ë¥¼ ë‹¤ë¥¸ í•™ìŠµë°©ë²•ìœ¼ë¡œ ì ìš©ì‹œì¼œ ì—°êµ¬í•˜ê³  ì‹¶ì€ ë‚˜ì—ê²Œ ìˆì–´ ë§¤ìš° ë‹¨ë¹„ê°™ì€ ê·¸ëŸ° ë…¼ë¬¸ì´ë„ê¹Œ ã…ã…


### Framework overview

ë¨¼ì €, ì´ ë…¼ë¬¸ì—ì„œ ì£¼ì¥í•˜ëŠ” ëª¨ë¸ì˜ ì•„í‚¤í…ì³ ì „ë°˜ì„ ì‚´í´ë³´ì. 

![image](https://user-images.githubusercontent.com/53431568/188362162-1a5700fb-98ef-4e45-988c-f98984f10cb4.png)

few-shot learningê³¼ ê°™ì´ support setê³¼ query setì´ inputìœ¼ë¡œ ë“¤ì–´ê°€ê³  1) feature embedding ì„ ê±°ì³ ë‚˜ì˜¨ featureë¥¼ í•œë©´ 2) depth attention poolingì„ ê±°ì¹œ í›„ support featureì™€ query featureì˜ concateì„ ì‹œí–‰í•˜ì—¬, 3) ë§ˆì§€ë§‰ convolution layersë“¤ì„ ê±°ì³ concatenationëœ feature ê°’ê³¼ 2)ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ë‚˜ì˜¨ feature ê°’ì„ ê³±í•˜ì—¬ ì‚¬ìš©í•œë‹¤. 

ì´ ë‹¨ê³„ë“¤ì´ ì˜ë¯¸í•˜ëŠ” ë°”ê°€ ë¬´ì—‡ì¸ì§€ í•˜ë‚˜ì”© ì•Œì•„ë³´ì!

### Stage1 : Feature Embedding

![image](https://user-images.githubusercontent.com/53431568/188363016-7987db8b-8242-4bf0-ae4a-48f65a9ff233.png)

ì²«ë²ˆì§¸ë¡œëŠ” inputìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” support set ì´ë¯¸ì§€ë“¤ê³¼ query set ì´ë¯¸ì§€ë“¤ì— ëŒ€í•˜ì—¬ ê°ê° featureë¥¼ ë½‘ëŠ” ê²ƒì´ë‹¤. ì´ ëª¨ë¸ìì²´ëŠ” relation networkë¡œ êµ¬ì„±ë˜ì–´ìˆìœ¼ë©°, ì²«ë²ˆì§¸ ë‹¨ê³„ì— í•´ë‹¹í•˜ëŠ” layerëŠ” 4ê°œì˜ convolution blockìœ¼ë¡œ, ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±ë˜ì–´ìˆë‹¤. 

- Relation network convolution
> Each convolution block has
> 
> 3x3 convolution of 64 filters
> 
> Batch normalization
> 
> Relu activation function layer
> 
> 2x2 max pooling

feature embedding ë¶€ë¶„ì˜ ì‹ì„ $f_\theta$ ë¼ê³  í–ˆì„ ë•Œ, 

- feature map of support set : $f_\theta(S^{(i)})$
- feature map of query set : $f_\theta(Q^{(j)})$ 


### Stage2 : Salient Discriminative Feature Learning

![image](https://user-images.githubusercontent.com/53431568/188430852-4e4c4439-2ad3-4875-a5fe-36997b44d0ad.png)

#### 1) Depth Average Pooling (DAP)

![image](https://user-images.githubusercontent.com/53431568/188363678-97cd3465-da53-439a-a6c7-f90d21a546b6.png)

ì´ ë¶€ë¶„ì— ëŒ€í•´ì„œ í•´ì„ì´ ì¢€ ì–´ë ¤ì› ëŠ”ë°, depth average pooling í•˜ë‹ˆê¹Œ ë‹¹ì—°íˆ channel attentionì´ê² ê±°ë‹ˆ~ ìƒê°ì„ í–ˆëŠ”ë°, ì§„ì‘ì— channel attentionì´ì—ˆë‹¤ë©´ Global Average Poolingì´ë¼ëŠ” ê°œë…ì´ ìˆëŠ”ë°, ê·¸ ë‹¨ì–´ë¥¼ ì¼ê² ì§€! ë¼ëŠ” ìƒê°ì´ ë“¤ì–´ ë‹¤ì‹œ ë…¼ë¬¸ì„ ê¼¼ê¼¼í•˜ê²Œ ì½ì—ˆë‹¤. ì½ì–´ë³´ë‹ˆ, channel attentionì€ ì•„ë‹ˆê³ , ë ˆì´ë¸”ì´ ê°™ì€ support set ì´ë¯¸ì§€ë“¤ì´ ì—¬ëŸ¬ê°œê°€ ë“¤ì–´ì˜¤ê²Œ ë˜ëŠ”ë°, ê°™ì€ ë ˆì´ë¸”ì— í•´ë‹¹í•˜ëŠ” ì´ë¯¸ì§€ë“¤ì— ëŒ€í•´ì„œ DAPë¥¼ í•´ì£¼ëŠ” ê²ƒì´ì—ˆë‹¤! ê·¸ë˜ì„œ í•œ ë ˆì´ë¸”ì— ëŒ€í•œ ì—¬ëŸ¬ support set ì´ë¯¸ì§€ë“¤ì€ í•˜ë‚˜ì˜ feature mapìœ¼ë¡œ poolingì´ ëœë‹¤. êµ¬ì²´ì ìœ¼ë¡œ ì¨ìˆì§„ ì•Šì§€ë§Œ, ë…¼ë¬¸ì—ì„œ ì œì‹œí•˜ëŠ” ìˆ˜ì‹ê³¼, ê¸€ì— ê·¼ê±°í•˜ë©´ ì´ë ‡ê²Œ ë˜ëŠ” ê²ƒì´ ë§ì„ ê²ƒì´ë‹¤. ë˜í•œ, support set ë“¤ ê°„ì˜ ê´€ê³„ë¥¼ average pooling ë°©ì‹ìœ¼ë¡œ ê³„ì‚°í•œë‹¤ëŠ” ì ì—ì„œ ê´œì°®ì€ ë°©ë²•ì¸ ê²ƒ ê°™ë‹¤ê³  ìƒê°í•œë‹¤. 

> DAP ëŠ” support set ì´ë¯¸ì§€ë“¤ì—ë§Œ í•´ì£¼ëŠ”ë° ê·¸ ì´ìœ ëŠ”, ì´ í’€ë§ì„ ê±°ì¹˜ë©´ ê° ì´ë¯¸ì§€ë“¤ì´ ê°€ì§„ `"commonality"`ë¥¼ ë½‘ê³ , ìœ ì‚¬í•˜ì§€ ì•Šì€ ë‹¤ë¥¸ ë¶€ë¶„ì— ëŒ€í•´ì„œëŠ” ì •ë³´ë¥¼ ì—†ì•¨ ìˆ˜ ìˆì—ˆë‹¤ê³  í•œë‹¤. 


#### 2) JS Divergence

ì´ê±´ GAN ë…¼ë¬¸ë¦¬ë·°í•˜ê³  ê°œë… ì •ë¦¬ë¥¼ í•˜ë©´ì„œ ë‹¤ë¤˜ë˜ ê°œë…ì´ë¼ â¡ï¸ [[GAN study] KL-divergence & JS-divergence & Maximum Likelihood Estimationì™€ ê°œë…ì •ë¦¬](https://chaelin0722.github.io/gan/KL_divergence&JS_divergence/) í˜¹ì€ [[ë…¼ë¬¸ì •ë¦¬ğŸ“ƒ] Generative Adversarial Nets](https://chaelin0722.github.io/paperreview/generative_adversarial_nets/) ì´ í¬ìŠ¤íŒ…ì„ ì°¸ê³ í•˜ë©´ ì´í•´ê°€ ë¹ ë¥¼ ê²ƒ ê°™ë‹¤. 

$D_{JS}^{i,j} (P(f^a_\theta(S^{(j)})),P(f^a_\theta(S^{(j)}))) $

ì´ metricì˜ ì¥ì ì€..

- JS Divergence ë¡œ lossë¥¼ ê³„ì‚°í•˜ì—¬ ê°ì • ì´ë¯¸ì§€ë¥¼ êµ¬ë¶„í•˜ëŠ” ëŠ¥ë ¥ì„ ì¦ëŒ€ì‹œí‚¬ ìˆ˜ ìˆë‹¤. 
- ë‹¤ë¥¸ í´ë˜ìŠ¤ë¼ë¦¬ ë©€ë¦¬ ë–¨ì–´ì§ˆ ìˆ˜ ìˆë„ë¡ penalize í•  ìˆ˜ ìˆë‹¤.

DAPì˜ ì‹
- Feature map of support setâ€™s DAP : $f^a_\theta(S^{(j)})$

ê²°êµ­ stage2ì—ì„œ ì‚¬ìš©í•˜ëŠ” Loss functionì˜ ìµœì¢…ì‹ì€!

$L_{dist}^k = 1 - $ $1\over{N^2}$ $\sum^N_{i=1} \sum^N_{j=1} [y_k^{i,j} - D_{JS}^{i,j} (P(f^a_\theta(S^{(j)})),P(f^a_\theta(S^{(j)})))]^2$

### Stage3 : Emotion Similarity Learning

![image](https://user-images.githubusercontent.com/53431568/188430779-e559efa9-a541-4b42-844a-6b051987e12c.png)

ì´ ë‹¨ê³„ì—ì„œëŠ”, ë°”ë¡œ ì „ ë‹¨ê³„ì—ì„œ êµ¬í•œ DAP ë¥¼ ê±°ì¹œ support set feature ê³¼, query set feature ì„ concatenation ì„ ì‹œì¼œ relation networkì˜ ë‚˜ë¨¸ì§€ 4ê°œì˜ layerì„ ê±°ì¹˜ê²Œ í•œë‹¤.

ë˜í•œ, dap ë¥¼ ê±°ì¹˜ì§€ ì•Šì€ support setê³¼ query setì˜ similarityë¥¼ êµ¬í•˜ê¸° ìœ„í•´, concate í•œ featureê°€ ë‚˜ì˜¨ featureì™€ ê·¸ëƒ¥ 8ê°œì˜ layerì„ ê±°ì³ë‚˜ì˜¨ featureì˜ ê³±ìœ¼ë¡œ lossë¥¼ ê³„ì‚°í•´ì¤€ë‹¤. ë”°ë¼ì„œ, ì´ë²ˆ ë‹¨ê³„ì—ì„œ ê³„ì‚°í•˜ëŠ” loss functionì€ ë‹¤ìŒê³¼ ê°™ë‹¤. 

$L_r^{(k)} =$ $1\over{N^2}$ $\sum^N_{i=1} \sum^N_{j=1} [y_k^{(i,j)} - r^{i,j} (g_ğœ‘ [C(f^a_\theta(S^{(j)})),P(f^a_\theta(S^{(j)}))])]^2$


### ìµœì¢… CRN Loss

$L_{CRN} =$ $1\over{K}$ $\sum^K_{k=1} (L_r^k + \lambda L_{dist}^k )$


### Experiment details

ì´ ë…¼ë¬¸ì—ì„œëŠ” ê° ë°ì´í„°ë§ˆë‹¤ emotion label ì— í•´ë‹¹í•˜ëŠ” ì´ë¯¸ì§€ì˜ ê°¯ìˆ˜ê°€ ë§¤ìš° ìƒì˜í•˜ë‹¤ë©´ì„œ imbalance ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, ë¹„ìŠ·í•˜ê²Œ ê°€ì§€ê³  ìˆëŠ” ìˆ˜ì˜ labelì„ trainìœ¼ë¡œ, ì ì€ ì´ë¯¸ì§€ìˆ˜ë¥¼ ê°–ê³  ìˆëŠ” ë ˆì´ë¸”ì„ testë¡œ í•˜ì—¬ì„œ ì‹¤í—˜ì„ ì§„í–‰í–ˆë‹¤ê³  í•œë‹¤. 

![image](https://user-images.githubusercontent.com/53431568/188431661-f9a4ade8-07f6-47ec-939f-7751b20d905b.png)

í•˜ì§€ë§Œ trainì— ì´ë¯¸ì§€ë¥¼ í‘œì— ë‚˜ì˜¨ê²ƒì„ ë‹¤ ì¼ëŠ”ì§€ ì•„ë‹Œì§€ëŠ” ìì„¸íˆ ì„œìˆ í•˜ì§€ ì•Šì•„ ì •í™•í•œ ì •ë³´ëŠ” ëª¨ë¥¸ë‹¤. ë˜í•œ, n-shot k-way ì— ëŒ€í•˜ì—¬ nê³¼ k ì— ëŒ€í•œ ì •ë³´ë„ ì„œìˆ ë˜ì–´ìˆì§€ ì•ŠìŒ.. í 



### Experiment Results

- RAF-DB

![image](https://user-images.githubusercontent.com/53431568/188431958-f961ff12-1f3a-44fb-989d-71b132e511b2.png)


- FER2013

![image](https://user-images.githubusercontent.com/53431568/188432031-e7c8e2e2-314f-4f6a-9f30-37efbf9b006a.png)


- SFEW

![image](https://user-images.githubusercontent.com/53431568/188432044-79200a43-fb20-44cb-8f0c-8fa2833d4501.png)


###  generated feature maps with different emotion categories with/without the JS 

![image](https://user-images.githubusercontent.com/53431568/188604101-f6c080b5-1a3a-42b1-8f59-6cb7dbadef00.png)

### Model Ablation 

![image](https://user-images.githubusercontent.com/53431568/188604186-fc93024f-f5dd-4b7a-9f6e-d28211ac015a.png)


